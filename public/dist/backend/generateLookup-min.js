"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();Object.defineProperty(exports,"__esModule",{value:!0});var _cheerio=require("cheerio"),_cheerio2=_interopRequireDefault(_cheerio),_path=require("path"),_path2=_interopRequireDefault(_path),_colors=require("colors"),_colors2=_interopRequireDefault(_colors),_lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_q=require("q"),_q2=_interopRequireDefault(_q),_logger=require("./logger"),_logger2=_interopRequireDefault(_logger),_util=require("./util"),_util2=_interopRequireDefault(_util);exports["default"]=function(componentFileNames,baseDirAuraUpstream,outputDirDataPath){var mainDefer=_q2["default"].defer(),promises=[],interestedFiles=_lodash2["default"].merge(_lodash2["default"].values(componentFileNames.cmp),_lodash2["default"].values(componentFileNames.app)),auraUpstreamPomFileContent=void 0,dependenciesMap={},usageMap={},namespaceCountMap={},controlCountMap={},controlLocationMap={};_logger2["default"].log("[Begin parsing]:".yellow,_lodash2["default"].size(interestedFiles)),_lodash2["default"].each(interestedFiles,function(fileName){var defer=_q2["default"].defer();promises.push(defer.promise);var _util$getComponentNam=_util2["default"].getComponentNamesFromPath(fileName),_util$getComponentNam2=_slicedToArray(_util$getComponentNam,2),controlNameSpace=_util$getComponentNam2[0],controlName=_util$getComponentNam2[1],controlFullName=controlNameSpace+":"+controlName,curControlObj={attributes:{},imports:{},events:{},handlers:{},methods:{},dependencies:{}};_util2["default"].addNamespaceCountMapEntry(namespaceCountMap,controlNameSpace,1),_util2["default"].setDependenciesMapEntry(dependenciesMap,controlNameSpace,controlName,curControlObj);var relativeControlPath=fileName.substr(fileName.indexOf("aura_upstream/"));relativeControlPath=relativeControlPath.substr(0,relativeControlPath.lastIndexOf("/")),controlLocationMap[controlFullName]=relativeControlPath,_util2["default"].readFromFileAsync(fileName).then(function(fileContent){var relativeFileName=_util2["default"].getControlRelativePath(fileName);try{var $=_cheerio2["default"].load(fileContent,{xmlMode:!0});_lodash2["default"].each($("*"),function(attribute){var name=attribute.name,attribs=attribute.attribs,children=attribute.children;switch(_util2["default"].appendUsageMapByName(usageMap,name,controlFullName,{controlNameSpace:controlNameSpace,controlName:controlName,controlFullName:controlFullName,attribs:attribs}),name.toLowerCase()){case"aura:attribute":var _util$getKeyValFromCh=_util2["default"].getKeyValFromCheerioDom(attribute),_util$getKeyValFromCh2=_slicedToArray(_util$getKeyValFromCh,2),curAttrName=_util$getKeyValFromCh2[0],curAttrAttributes=_util$getKeyValFromCh2[1];curControlObj.attributes[curAttrName]=curAttrAttributes;break;case"aura:import":var library=attribs.library;curControlObj.imports[library]=attribs;break;case"aura:registerevent":var eventName=attribs.name;curControlObj.events[eventName]=attribs;break;case"aura:handler":var handlerName=attribs.name;curControlObj.handlers[handlerName]=attribs;break;case"aura:method":var methodName=attribs.name,childrenAttrs=_lodash2["default"].reduce(children||[],function(resChildAttrs,curChildAttr){if("aura:attribute"===curChildAttr.name&&attribs){var _util$getKeyValFromCh3=_util2["default"].getKeyValFromCheerioDom(curChildAttr),_util$getKeyValFromCh4=_slicedToArray(_util$getKeyValFromCh3,2),childAttrName=_util$getKeyValFromCh4[0],childAttrAttributes=_util$getKeyValFromCh4[1];resChildAttrs[childAttrName]=childAttrAttributes}return resChildAttrs},{});curControlObj.methods[methodName]=childrenAttrs;break;case"aura:component":break;default:var depdenciesName=name;_util2["default"].isValidDependencies(depdenciesName)&&(_util2["default"].appendDependenciesPropInControlObj(curControlObj,depdenciesName,attribs),_util2["default"].addControlCountMapEntry(controlCountMap,depdenciesName,1))}}),defer.resolve(relativeFileName+" done")}catch(e){defer.reject(relativeFileName+" : "+e)}})});var deferAuraPomXml=_q2["default"].defer();promises.push(deferAuraPomXml.promise),_util2["default"].readFromFileAsync(_path2["default"].join(baseDirAuraUpstream,"pom.xml")).done(function(fileContent){auraUpstreamPomFileContent=fileContent,deferAuraPomXml.resolve()}),_logger2["default"].log("[Waiting for promises]: ".yellow,promises.length),_q2["default"].allSettled(promises).then(function(results){_logger2["default"].log("[Promises Returned]: ".yellow);var promiseSuccessCount=0,promiseFailCount=0,promisesErrors=[];_lodash2["default"].each(results,function(result){var reason=(result.value,result.reason);"fulfilled"!==result.state?(promisesErrors.push(reason),promiseFailCount++):promiseSuccessCount++}),mainDefer.resolve({promisesErrors:promisesErrors,promiseSuccessCount:promiseSuccessCount,promiseFailCount:promiseFailCount})}).then(function(_ref){var promisesErrors=_ref.promisesErrors,promiseSuccessCount=_ref.promiseSuccessCount,promiseFailCount=_ref.promiseFailCount;_logger2["default"].log("[Promises Statistics:]".yellow,promiseSuccessCount+" succeeded",promiseFailCount+" failed"),_lodash2["default"].each(promisesErrors,function(promiseError){return _logger2["default"].log("[Promise Failed]: ".red,promiseError)}),mainDefer.resolve()}),mainDefer.promise.then(function(){_logger2["default"].log("[Main Promise Returned, Writing Output]:".yellow);var remappedControlCountMap=_lodash2["default"].reduce(controlCountMap,function(res,controlReferencesCount,controlName){var fullControlName=controlCountMap[controlName+".app"]?controlName+".app":controlName+".cmp";return res[fullControlName]=controlReferencesCount,res},{}),_writeToFile=function(jsonSerialization,content,outputFileName){var contentToWrite=jsonSerialization?_util2["default"].serializeJsonObject(content):content,outputFullPath=_path2["default"].join(outputDirDataPath,outputFileName);_logger2["default"].log("	[Writing To]: ".yellow,outputFullPath.blue,contentToWrite.length),_util2["default"].writeToFile(contentToWrite,outputFullPath)};_logger2["default"].log("[Making Output Dir]".yellow,outputDirDataPath);try{_util2["default"].mkDir(outputDirDataPath),_logger2["default"].log("	[OuputDir Created]".yellow)}catch(e){_logger2["default"].log("	[Skipped]".yellow,e)}_logger2["default"].log("[Writing Output]".yellow);try{_writeToFile(!0,dependenciesMap,"dependenciesMap.json"),_writeToFile(!0,usageMap,"usageMap.json"),_writeToFile(!0,namespaceCountMap,"namespaceCountMap.json"),_writeToFile(!0,remappedControlCountMap,"controlCountMap.json"),_writeToFile(!0,controlLocationMap,"autoCompleteControlMap.json"),_writeToFile(!0,controlLocationMap,"controlLocationMap.json"),_writeToFile(!1,auraUpstreamPomFileContent,"aura_upstream_pom.xml")}catch(ex){_logger2["default"].log("[Main Defer Error]".red,ex)}})};